

## oracle 备库cdc方案适配

## 背景

针对logminer方向针对[以上方案](https://ax67urab32o.feishu.cn/wiki/MVScwYUAgiUHpWkd5Pbct7eNnng)综合对比选择挖掘库方式进行cdc。设计到debezium的代码改动。环境信息DataGurad（主库ORACDB1+从库ORACDB2）+MiningDB(ORACDB3)。代码改动以下方面：

1. 涉及到Logminer的操作转发至ORACDB3
2. logminer策略使用离线字典方式
3. 查询表结构（备库不支持）
4. Debezium scn存储策略调整
5. 通过.log后缀判断是redo还是archive，并且增加archive和redo的关系映射 archivelog_path_convert和redo_path_convert完成备库和主库的路径转换。
6. 查询log sql 适配备库

## 要求

相同版本

挖掘库和备库可以共享文件

## 挖掘数据源相关

**database.hostname|dbname等信息配置物理备库地址**

另外代码中创建挖掘连接miningConnection，logminer相关操作转发miningConnection完成。（处理中）

## logminer离线字典

默认使用online策略，调整为使用离线字典，需要注意的问题是启动前表结构变更且dictionary不包含的问题（后期flink cdc验证)

```SQL
BEGIN sys.dbms_logmnr.start_logmnr( +
                startScn => ' + startScn + ',  +
                endScn => ' + endScn + ',  +
                DICTFILENAME =>  '/opt/oracle/oradata/ORACDB3/dictionary.ora',
                OPTIONS => SYS.DBMS_LOGMNR.SKIP_CORRUPTION + SYS.DBMS_LOGMNR.NO_SQL_DELIMITER +SYS.DBMS_LOGMNR.NO_ROWID_IN_STMT + SYS.DBMS_LOGMNR.STRING_LITERALS_IN_STMT); 
END;
```

## 查询表结构

```SQL
--修改前
begin dbms_metadata.set_transform_param(DBMS_METADATA.SESSION_TRANSFORM, 'STORAGE', false); end;
begin dbms_metadata.set_transform_param(DBMS_METADATA.SESSION_TRANSFORM, 'SEGMENT_ATTRIBUTES', false); end;
begin dbms_metadata.set_transform_param(DBMS_METADATA.SESSION_TRANSFORM, 'SQLTERMINATOR', true); end;
SELECT dbms_metadata.get_ddl('TABLE','STUDENT','C##FLINKUSER') FROM DUAL;
--修改后
SELECT column_name, data_type, data_length, data_precision, data_scale, nullable
FROM dba_tab_columns
WHERE owner = 'C##FLINKUSER' AND table_name = 'STUDENT';
```

## Debezium scn的策略

Debezium 会将当前数据库的scn保存到**LOG_MINING_FLUSH表中，**因为连接的是备库注释掉相关内容，也可以参考[DBZ-3866](https://github.com/debezium/debezium/pull/4170/commits/df2315fec9fd6fbd82e6ee94b51d9c3d7ddd86b8)修改，当前后期可以将写策略调到挖掘库中。

## 使用

```
io.debezium.connector.oracle.CDCTest
```

## 环境配置

### dg

```yaml
version: '3.5'
services:
  db1:
    image: oracle/database:12.2.0.1-ee
    hostname: db1
    ports:
      - "11521:1521"
      - "15500:5500"
      - "18080:8080"
    volumes:
      - "/hadoop/12/db1/opt/oracle/oradata/:/opt/oracle/oradata/:rw"
      - "/hadoop/12/db1/opt/oracle/fast_recovery_area/:/opt/oracle/fast_recovery_area/:rw"
    environment:
      - ORACLE_SID=ORACDB1
      - ORACLE_PDB=ORAPDB
      - ORACLE_PWD=P%ssw0rd
      - ORACLE_CHARACTERSET=AL32UTF8
      - ENABLE_ARCHIVELOG=true
  db2:
    image: oracle/database:12.2.0.1-ee
    hostname: db2
    ports:
      - "21521:1521"
      - "25500:5500"
      - "28080:8080"
    volumes:
      - "/hadoop/12/db2/opt/oracle/oradata/:/opt/oracle/oradata/:rw"
      - "/hadoop/12/db2/opt/oracle/fast_recovery_area/:/opt/oracle/fast_recovery_area/:rw"
    environment:
      - ORACLE_SID=ORACDB2
      - ORACLE_PDB=ORAPDB
      - ORACLE_PWD=P%ssw0rd
      - ORACLE_CHARACTERSET=AL32UTF8
      - ENABLE_ARCHIVELOG=true

```

### mining database

```
version: '3.5'
services:
  db3:
    image: oracle/database:12.2.0.1-ee
    #container_name: single_db
    hostname: db3
    ports:
      - "1521:1521"
      - "5500:5500"
      - "8080:8080"
    volumes:  #下面的映射除了docker文件的挂载还需要将dataguard中的standby的目录映射到该挖掘
      - "/hadoop/12/db3/opt/oracle/oradata/:/opt/oracle/oradata/:rw"
      - "/hadoop/12/db3/opt/oracle/fast_recovery_area/:/opt/oracle/fast_recovery_area/:rw"
      - "/hadoop/12/db2/opt/oracle/oradata/ORACDB2:/opt/oracle/cv:r"
      - "/hadoop/12/db2/opt/oracle/fast_recovery_area:/opt/oracle/cv_fast_recovery_area:r"
    environment:
      - ORACLE_SID=ORACDB3
      - ORACLE_PDB=ORAPDB
      - ORACLE_PWD=P%ssw0rd
      - ORACLE_CHARACTERSET=AL32UTF8
      - ENABLE_ARCHIVELOG=true

```

